apiVersion: gateway.kgateway.dev/v1alpha1
kind: GlooTrafficPolicy
metadata:
  name: mcp-oauth-policy
  namespace: mcp-demo-entra
  labels:
    app: mcp-gateway
spec:
  targetRefs:
    - group: gateway.kgateway.dev
      kind: Gateway
      name: mcp-gateway
  policy:
    cors:
      allowOrigins:
        - "*"
      allowMethods:
        - GET
        - POST
        - OPTIONS
      allowHeaders:
        - "*"
      exposeHeaders:
        - "*"
      maxAge: 86400
    glooJWT:
      providers:
        entra:
          # IMPORTANT: Replace {TENANT_ID} and {CLIENT_ID} with your actual values
          # Run the setup-entra.sh script to configure these automatically
          issuer: "https://login.microsoftonline.com/{TENANT_ID}/v2.0"
          audiences:
            - "{CLIENT_ID}"
          jwks:
            remote:
              url: "https://login.microsoftonline.com/{TENANT_ID}/discovery/v2.0/keys"
              cacheDuration: 5m
    mcpAuthorization:
      rules:
        # Public tool - any authenticated user can call
        - name: allow-echo
          expression: 'mcp.tool.name == "echo"'

        # Any authenticated user can get their own info
        - name: allow-get-user-info
          expression: 'mcp.tool.name == "get_user_info"'

        # Requires files.read scope (Entra uses 'scp' claim with space-separated values)
        # Note: In Entra, scopes are in the 'scp' claim as a space-separated string
        - name: allow-list-files
          expression: 'mcp.tool.name == "list_files" && jwt.scp.contains("files.read")'

        # Requires files.delete scope AND admin role
        # Entra app roles are in the 'roles' claim as an array
        - name: allow-delete-file
          expression: 'mcp.tool.name == "delete_file" && jwt.scp.contains("files.delete") && jwt.roles.contains("admin")'

        # Requires admin role only
        - name: allow-system-status
          expression: 'mcp.tool.name == "system_status" && jwt.roles.contains("admin")'