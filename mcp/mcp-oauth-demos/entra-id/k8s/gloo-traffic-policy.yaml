apiVersion: gateway.kgateway.dev/v1alpha1
kind: GlooTrafficPolicy
metadata:
  name: mcp-oauth-policy
  namespace: mcp-demo-entra
  labels:
    app: mcp-gateway
spec:
  targetRefs:
    - group: gateway.kgateway.dev
      kind: Gateway
      name: mcp-gateway
  policy:
    # CORS configuration for browser-based clients
    cors:
      allowOrigins:
        - "*"
      allowMethods:
        - GET
        - POST
        - OPTIONS
      allowHeaders:
        - "*"
      exposeHeaders:
        - "*"
      maxAge: 86400

    # JWT validation configuration for Microsoft Entra ID
    glooJWT:
      providers:
        entra:
          # IMPORTANT: Replace {TENANT_ID} and {CLIENT_ID} with your actual values
          # Run the setup-entra.sh script to configure these automatically
          issuer: "https://login.microsoftonline.com/{TENANT_ID}/v2.0"
          audiences:
            - "{CLIENT_ID}"
          jwks:
            remote:
              url: "https://login.microsoftonline.com/{TENANT_ID}/discovery/v2.0/keys"
              cacheDuration: 5m
          # Optional: Configure header forwarding to pass JWT claims to the MCP server
          claimsToHeaders:
            - claim: sub
              header: X-JWT-Claim-Sub
            - claim: email
              header: X-JWT-Claim-Email
            - claim: preferred_username
              header: X-JWT-Claim-Preferred-Username

    # MCP-specific authorization rules using CEL expressions
    # These rules are evaluated AFTER JWT validation succeeds
    mcpAuthorization:
      rules:
        # Public tool - any authenticated user can call
        - name: allow-echo
          expression: 'mcp.tool.name == "echo"'

        # Any authenticated user can get their own info
        - name: allow-get-user-info
          expression: 'mcp.tool.name == "get_user_info"'

        # Requires files.read scope (Entra uses 'scp' claim with space-separated values)
        # Note: In Entra, scopes are in the 'scp' claim as a space-separated string
        - name: allow-list-files
          expression: 'mcp.tool.name == "list_files" && jwt.scp.contains("files.read")'

        # Requires files.delete scope AND admin role
        # Entra app roles are in the 'roles' claim as an array
        - name: allow-delete-file
          expression: 'mcp.tool.name == "delete_file" && jwt.scp.contains("files.delete") && jwt.roles.contains("admin")'

        # Requires admin role only
        - name: allow-system-status
          expression: 'mcp.tool.name == "system_status" && jwt.roles.contains("admin")'

---
# HTTPRoute to connect the Gateway to the MCPTarget
apiVersion: gateway.kgateway.dev/v1
kind: HTTPRoute
metadata:
  name: mcp-route
  namespace: mcp-demo-entra
  labels:
    app: mcp-gateway
spec:
  parentRefs:
    - name: mcp-gateway
  rules:
    - backendRefs:
        - group: gateway.kgateway.dev
          kind: MCPTarget
          name: demo-mcp-server
